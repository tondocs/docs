[https://github.com/ton-blockchain/docs/blob/master/docs/networking/index.md]

Сеть TON

Проект TON использует собственные протоколы peer-to-peer.


Блокчейн TON использует эти протоколы для распространения новых блоков, отправки и сбора кандидатов на транзакции и так далее.Если сетевые требования одноблокчейновых проектов, таких как Bitcoin или Ethereum, могут быть удовлетворены довольно легко (по сути, нужно построить одноранговую оверлейную сеть и распространять все новые блоки и кандидаты на транзакции с помощью протокола gossip), то многоблокчейновые проекты, такие как TON Blockchain, гораздо более требовательны (например, нужно иметь возможность подписаться на обновления только некоторых шардчейнов, не обязательно всех).
Экосистемные сервисы TON (например, TON Proxy, TON Sites, TON Storage) работают на основе этих протоколов.Как только более сложные сетевые протоколы, необходимые для поддержки блокчейна TON, будут созданы, окажется, что их можно легко использовать для целей, не обязательно связанных с непосредственными потребностями блокчейна TON, что дает больше возможностей и гибкости для создания новых услуг в экосистеме TON.


ADNL

Реализация.

Краеугольным камнем в сети TON является абстрактный уровень сети дейтаграмм (ADNL).

Это оверлейный, одноранговый, ненадежный (малогабаритный) протокол дейтаграмм, работающий поверх UDP в IPv4 (в будущем IPv6), с необязательным резервным TCP, если UDP.

Каждый участник имеет 256-битный адрес ADNL.

Протокол ADNL позволяет отправлять (ненадежно) и получать дейтаграммы, используя только эти адреса ADNL. IP-адреса и порты скрыты протоколом ADNL.

Адрес ADNL по сути равен 256-битному открытому ключу ECC. Этот открытый ключ может быть сгенерирован произвольно, что позволяет создать столько различных сетевых идентификаторов, сколько захочет узел. Однако для получения (и расшифровки) сообщений, предназначенных для такого адреса, необходимо знать соответствующий закрытый ключ.

На самом деле, адрес ADNL не является самим открытым ключом; вместо этого он представляет собой 256-битный хэш sha256 сериализованного TL-объекта, который может описывать несколько типов открытых ключей и адресов в зависимости от своего конструктора.

Обычно каждая отправленная датаграмма подписывается отправителем и шифруется так, чтобы только получатель мог расшифровать сообщение, а получатель мог проверить целостность по подписи.

Узел TON ADNL имеет некоторую "таблицу соседей", содержащую информацию о других известных узлах, такую как их абстрактные адреса и их открытые ключи, IP-адреса и UDP-порты. Затем он будет постепенно расширять эту таблицу, используя информацию, полученную от этих известных узлов в качестве ответов на специальные запросы, и иногда удалять устаревшие записи.

ADNL позволяет устанавливать каналы point-to-point и туннели (цепочка прокси-серверов).

На основе ADNL можно построить TCP-подобный потоковый протокол.

Подробнее о ADNL читайте в главе 3.1 Белой книги TON.

Оверлейные подсети

Реализация.

В системе с несколькими блокчейнами, такой как блокчейн TON, даже полные узлы обычно заинтересованы в получении обновлений (т.е. новых блоков) только о некоторых шардчейнах. Для этого внутри сети TON на основе протокола ADNL создаются специальные оверлейные подсети, по одной для каждого шардчейна.

Кроме того, оверлейные подсети используются для работы TON Storage, TON Proxy и так далее.

В отличие от ADNL, оверлейные сети TON обычно не поддерживают отправку дейтаграмм на произвольные другие узлы. Вместо этого между некоторыми узлами (называемыми "соседями" по отношению к рассматриваемой оверлейной сети) устанавливаются "полупостоянные связи", и сообщения обычно пересылаются по этим связям (т.е. от узла к одному из его соседей).

Каждая оверлейная подсеть имеет 256-битный идентификатор сети, обычно равный sha256 описания оверлейной сети - TL-сериализованного объекта.

Оверлейные подсети могут быть общедоступными или частными.

Оверлейные подсети работают в соответствии со специальным протоколом gossip.

Подробнее об оверлейных подсетях ADNL читайте в главе 3.3 Белой книги TON.

RLDP

Реализация - https://github.com/ton-blockchain/ton/tree/master/rldp, https://github.com/ton-blockchain/ton/tree/master/rldp2, https://github.com/ton-blockchain/ton/tree/master/rldp-http-proxy.

Вместо TCP-подобного протокола используется надежный протокол дейтаграмм произвольного размера, построенный на основе ADNL и называемый RLDP. Этот надежный дейтаграммный протокол может быть использован, например, для отправки RPC-запросов на удаленные узлы и получения от них ответов.

TON DHT

Реализация - https://github.com/ton-blockchain/ton/tree/master/dht, https://github.com/ton-blockchain/ton/tree/master/dht-server

Распределенная хэш-таблица (DHT), подобная Kademlia, играет важнейшую роль в сетевой части проекта TON. Она используется для определения местоположения других узлов в сети.

Ключи TON DHT - это просто 256-битные целые числа. В большинстве случаев они вычисляются как sha256 объекта TL-сериализации.

Значения, присваиваемые этим 256-битным ключам, по сути, являются произвольными байтовыми строками ограниченной длины. Интерпретация таких байтовых строк определяется предварительным образом соответствующего ключа; он обычно известен как узел, который ищет ключ, так и узел, который хранит ключ.

В простейшем случае ключ представляет собой ADNL-адрес некоторого узла, а значение может быть его IP-адресом и портом.

Сопоставление ключ-значение TON DHT хранится на узлах DHT.

Каждый узел DHT имеет 256-битный адрес DHT. В отличие от адреса ADNL, адрес DHT не должен меняться слишком часто, иначе другие узлы не смогут найти ключи, которые они ищут.

Предполагается, что значение ключа K будет храниться на S ближайших к K узлах Kademlia.

Расстояние Kademlia = 256-битный ключ XOR 256-битный адрес узла DHT (не имеет ничего общего с географическим положением).

S - небольшой параметр, скажем, S = 7, необходимый для повышения надежности DHT (если бы мы хранили ключ только на одном узле, ближайшем к K, значение этого ключа было бы потеряно, если бы этот единственный узел вышел из сети).

Любой узел, участвующий в DHT, обычно ведет таблицу маршрутизации Kademlia.

Он состоит из 256 бакетов, пронумерованных от 0 до 255. i-е бакет будет содержать информацию о некоторых известных узлах (фиксированное число "лучших" узлов и, возможно, несколько дополнительных кандидатов), которые находятся на расстоянии по Kademlia от 2^i до 2^(i+1) - 1 от адреса узла a.

Эта информация включает их адреса DHT, IP-адреса и порты UDP, а также некоторую информацию о доступности, такую как время и задержка последнего пинга.

Когда узел Kademlia узнает о любом другом узле Kademlia в результате какого-либо запроса, он включает его в соответствующий бакет своей таблицы маршрутизации, сначала в качестве кандидата. Затем, если некоторые из "лучших" узлов в этой корзине выходят из строя (например, долго не отвечают на запросы (ping)), они могут быть заменены некоторыми из кандидатов. Таким образом, таблица маршрутизации Kademlia остается заполненной.

Пары ключ-значение могут добавляться и обновляться в TON DHT.

"Правила обновления" могут быть разными. В некоторых случаях они просто разрешают замену старого значения новым при условии, что новое значение подписано владельцем/создателем (подпись должна быть сохранена как часть значения, чтобы впоследствии ее могли проверить любые другие узлы после получения значения этого ключа). В других случаях старое значение каким-то образом влияет на новое. Например, оно может содержать номер последовательности, и старое значение перезаписывается только в том случае, если новый номер последовательности больше (для предотвращения атак повторного воспроизведения).

TON DHT используется не только для хранения IP-адресов узлов ADNL, но и для других целей - он может хранить список адресов узлов, хранящих определенный торрент TON Storage, список адресов узлов, входящих в оверлейную подсеть, ADNL-адреса сервисов TON или ADNL-адреса аккаунтов блокчейна TON и так далее.

Подробнее о TON DHT читайте в главе 3.2 Белой книги TON.