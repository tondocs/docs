[https://github.com/ton-blockchain/docs/blob/master/docs/smart-contracts/tvm_overview.md]

TVM

В этом документе представлен обзор того, как TVM (Telegram Open Network Virtual Machine) выполняет транзакции. Также имеется подробная спецификация (EN).

Транзакции и фазы

Когда на счете в одной из цепочек TON происходит какое-то событие, оно вызывает транзакцию. Наиболее распространенным событием является "поступление какого-либо сообщения", это могут быть tick-tock, merge, split и другие события.

Каждая транзакция состоит из 5 этапов.


Фаза хранения - в этой фазе рассчитывается плата за хранение, начисленная контрактом в связи с занятием некоторого пространства в состоянии цепи
Фаза кредитования - в этой фазе рассчитывается баланс контракта в отношении (возможной) стоимости входящего сообщения и собранной платы за хранение.
Фаза вычисления - в этой фазе выполняется TVM (см. ниже), результатом выполнения TVM является агрегация exit_code, actions (сериализованный список действий), gas_details, new_storage и некоторых других.
Фаза действий - если фаза вычислений прошла успешно, в этой фазе обрабатываются действия из фазы вычислений. В частности, actions могут включать отправку сообщений, обновление кода смарт-контракта, обновление библиотек и т.д. Обратите внимание, что некоторые действия могут быть неудачными во время обработки (например, мы пытаемся отправить сообщение с большим количеством TON, чем есть у контракта), в этом случае вся транзакция может быть возвращена или это действие может быть отменено (это зависит от режима действий, другими словами, контракт может отправить сообщение в режиме send-or-revert или в режиме try-send-if-no-ignore).
Фаза отскока - если фаза вычисления завершилась неудачно (вернула exit_code >= 2), в этой фазе формируется сообщение отскока для транзакций, инициированных входящим сообщением.


Фаза вычислений

В этой фазе происходит выполнение TVM.

Состояние TVM

В любой момент времени состояние TVM полностью определяется 6 свойствами состояния:


Стек (см. ниже)
Регистры управления - (см. ниже), говоря простым языком, до 16 переменных, которые могут быть непосредственно установлены и прочитаны во время выполнения
Текущее продолжение - объект, описывающий последовательность инструкций, которая выполняется в данный момент
Текущая кодовая страница - говоря простым языком, версия TVM, которая работает в настоящее время
Лимиты газа - набор из 4 целочисленных значений текущий лимит газа gl, максимальный лимит газа gm, остаток газа gr и кредит газа gc
Библиотечный контекст - хэш-карта библиотек, которые могут быть вызваны TVM


TVM - стековая машина

TVM - это last-input-first-output стековая машина. Существует 7 типов переменных, которые могут храниться в стеке:


Целочисленные - подписанные 257-битные целые числа
Комплекс - упорядоченная коллекция до 255 элементов, имеющих произвольные типы значений, возможно, различных
Нулевой


И четыре разных вида ячеек:


Ячейка - базовая (возможно вложенная) непрозрачная структура, используемая блокчейном TON для хранения всех данных
Срез - специальный объект, позволяющий читать из ячейки
Конструктор - специальный объект, позволяющий создавать новые ячейки
Продолжение - специальный объект, позволяющий использовать ячейку в качестве источника инструкций TVM


Инициализация TVM

Когда выполнение транзакции доходит до фазы вычислений, TVM инициализирует и затем выполняет команды (op-codes) из текущего продолжения, пока не останется команд для выполнения (и продолжения для возвратных переходов).

Подробное описание инициализации можно найти в разделе Ton-blockchain 4.4. Для обычных транзакций, вызванных сообщением, начальное состояние выглядит следующим образом:


стек: 5 элементов помещаются в стек

Баланс смарт-контракта (после зачисления стоимости входящего сообщения) передается в виде целочисленного количества нанотонн.
Баланс входящего сообщения m передается в виде целочисленного количества нанотонн.
Входящее сообщение передается в виде ячейки, которая содержит сериализованное значение типа Message X, где X - тип тела сообщения.
Тело входящего сообщения, равное значению поля m, передается как фрагмент ячейки.
Селектор функции s, целое число: 0 для tx, вызванных внутренними сообщениями, -1 для внешних и т.д. Именно целое число говорит о том, какое событие вызвало транзакцию.

Текущее продолжение : продолжение, преобразованное из раздела code смарт-контракта
Регистры инициализируются следующим образом: c0, c1, c2 и c3 являются пустыми. c4 содержит ячейку из секции data смарт-контракта. c5 содержит пустой список (он сериализуется как ячейка, которая содержит последнее действие в списке плюс ссылку на предыдущее) выходных действий. c7 инициализируется как комплекс с некоторыми основными данными контекста блокчейна, такими как time, global config, block_data и т.д. См. Ton-blockchain 4.4.10.
Текущая кодовая страница установлена в значение по умолчанию (cp=0)
Пределы газа инициализируются в соответствии с результатами кредитной фазы
Контекст библиотеки инициализируется в результате объединения коллекции библиотек смарт-контракта, глобальной коллекции библиотеки мастерчейна и коллекции библиотеки входящих сообщений (если таковые имеются).


Результат выполнения TVM

Кроме exit_code и данных о потребленном газе, TVM косвенно выводит следующие данные:


регистр c4 - ячейка, которая будет сохранена как новые данные (data) смарт-контракта (если исполнение не будет отменено на этой или последующих фазах)
c5 регистр - (список выходных действий) ячейка с последним действием в списке и ссылка на ячейку с предыдущим действием (рекурсивно)


Все остальные значения регистров будут игнорироваться.

Обратите внимание, что поскольку существует ограничение на максимальную глубину ячеек , и особенно ограничение на глубину c4 и c5 . Кроме того, существует ограничение на количество выходных действий в одном tx . Если контракту нужно отправить больше, он может послать сообщение с запросом continue_sending самому себе и отправить все необходимые сообщения в нескольких последующих транзакциях.